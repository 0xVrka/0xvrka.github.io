---
// src/components/TableOfContents.astro
import type { MarkdownHeading } from 'astro';
import katex from 'katex';

export interface Props {
  headings: MarkdownHeading[];
}

const { headings } = Astro.props;
const filteredHeadings = headings.filter(
  (h) => h.depth >= 1 && h.depth <= 3
);

const renderLatex = (text: string) => {
  const cleanText = text.replace(/`(\$[^`]+)`/g, '$1');
  return cleanText.replace(/\$([^$]+)\$/g, (match, math) => {
    try {
      return katex.renderToString(math, {
        throwOnError: false,
        displayMode: false,
      });
    } catch (e) {
      return match;
    }
  });
};
---

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">

<div
  class="toc
         sticky top-[4rem]           
         self-start w-full
         flex flex-col
         h-[calc(100vh-4rem-4rem)]  
         p-4 rounded-xl
         bg-[var(--card-color)]"
>
  <h3 class="toc-title">Table Of Contents</h3>

  <ul
    class="toc-list
           mt-2 flex-1
           overflow-y-auto no-scrollbar
           space-y-2
           "
  >
    {filteredHeadings.map(({ depth, slug, text }) => (
      <li class={`depth-${depth}`}>
        <a 
          href={`#${slug}`} 
          class="toc-link"
          set:html={renderLatex(text)}
        />
      </li>
    ))}
  </ul>
</div>

<style>
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }

  .toc { @apply p-4 rounded-xl bg-[var(--card-color)]; }
  .toc-title {
    @apply text-lg font-bold text-[var(--text-color)];
    font-family: var(--title-font);
    text-align: center;
  }
  .toc-list { @apply space-y-2; }
  .toc-link {
    @apply block text-[var(--text-color-lighten)] transition-colors;
  }
  .toc-link:hover { @apply text-[var(--primary-color)]; }
  .toc-link:hover :global(.katex) {
    color: var(--primary-color);
  }

  .toc-link.active {
    @apply text-white font-bold border-l-4 border-white pl-2;
  }
  .depth-1 { @apply ml-0; }
  .depth-2 { @apply ml-2; }
  .depth-3 { @apply ml-4; }

  :global(#sidebar.bg-black) .toc {
    background: transparent;
  }
</style>